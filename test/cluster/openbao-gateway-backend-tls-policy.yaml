# BackendTLSPolicy for OpenBao Gateway API
#
# This policy configures the Gateway to use HTTPS when communicating with the
# OpenBao backend service, and validates the backend certificate using the
# OpenBaoCluster's CA certificate.
#
# The Operator automatically creates:
# 1. A CA Secret named <cluster-name>-tls-ca containing the CA certificate
# 2. A ConfigMap with the same name containing the CA certificate in 'ca.crt' key
#    (required for BackendTLSPolicy as Traefik only supports ConfigMap references)
#
# Note: BackendTLSPolicy with validation automatically enables HTTPS protocol.
# The presence of this policy tells the Gateway to use HTTPS for backend connections.
apiVersion: gateway.networking.k8s.io/v1
kind: BackendTLSPolicy
metadata:
  name: openbaocluster-gateway-backend-tls
  namespace: openbaocluster-gateway
spec:
  targetRefs:
    - group: ""
      kind: Service
      name: openbaocluster-gateway-public
  validation:
    # Reference the CA certificate from the ConfigMap
    # Note: Traefik only supports ConfigMap references for caCertificateRefs
    # The ConfigMap must contain the CA certificate in a key named 'ca.crt'
    caCertificateRefs:
      - group: ""
        kind: ConfigMap
        name: openbaocluster-gateway-tls-ca
    # The hostname to verify in the backend certificate
    # This should match the service DNS name or the certificate SAN
    hostname: openbaocluster-gateway-public.openbaocluster-gateway.svc
---
apiVersion: gateway.networking.k8s.io/v1
kind: BackendTLSPolicy
metadata:
  name: openbaocluster-full-gateway-backend-tls
  namespace: openbaocluster-full
spec:
  targetRefs:
    - group: ""
      kind: Service
      name: openbaocluster-full-public
  validation:
    # Reference the CA certificate from the ConfigMap
    # Note: Traefik only supports ConfigMap references for caCertificateRefs
    # The ConfigMap must contain the CA certificate in a key named 'ca.crt'
    caCertificateRefs:
      - group: ""
        kind: ConfigMap
        name: openbaocluster-full-tls-ca
    # The hostname to verify in the backend certificate
    # This should match the service DNS name or the certificate SAN
    hostname: openbaocluster-full-public.openbaocluster-full.svc
