{{- if .Values.admissionPolicies.enabled }}
{{/*
ValidatingAdmissionPolicy to restrict what Sentinel can modify on OpenBaoCluster status
*/}}
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ include "openbao-operator.fullname" . }}-restrict-sentinel-mutations
  labels:
    {{- include "openbao-operator.labels" . | nindent 4 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups:
          - openbao.org
        apiVersions:
          - v1alpha1
        operations:
          - UPDATE
        resources:
          - openbaoclusters/status
  validations:
    - expression: |-
        !variables.is_sentinel || (
          (has(variables.new_status.phase) ? variables.new_status.phase : "") == (has(variables.old_status.phase) ? variables.old_status.phase : "") &&
          (has(variables.new_status.activeLeader) ? variables.new_status.activeLeader : "") == (has(variables.old_status.activeLeader) ? variables.old_status.activeLeader : "") &&
          (has(variables.new_status.readyReplicas) ? variables.new_status.readyReplicas : 0) == (has(variables.old_status.readyReplicas) ? variables.old_status.readyReplicas : 0) &&
          (has(variables.new_status.currentVersion) ? variables.new_status.currentVersion : "") == (has(variables.old_status.currentVersion) ? variables.old_status.currentVersion : "") &&
          (has(variables.new_status.initialized) ? variables.new_status.initialized : false) == (has(variables.old_status.initialized) ? variables.old_status.initialized : false) &&
          (has(variables.new_status.selfInitialized) ? variables.new_status.selfInitialized : false) == (has(variables.old_status.selfInitialized) ? variables.old_status.selfInitialized : false) &&
          (has(variables.new_status.lastBackupTime) ? variables.new_status.lastBackupTime : null) == (has(variables.old_status.lastBackupTime) ? variables.old_status.lastBackupTime : null) &&
          (has(variables.new_status.upgrade) ? variables.new_status.upgrade : null) == (has(variables.old_status.upgrade) ? variables.old_status.upgrade : null) &&
          (has(variables.new_status.backup) ? variables.new_status.backup : null) == (has(variables.old_status.backup) ? variables.old_status.backup : null) &&
          (has(variables.new_status.drift) ? variables.new_status.drift : null) == (has(variables.old_status.drift) ? variables.old_status.drift : null) &&
          (has(variables.new_status.blueGreen) ? variables.new_status.blueGreen : null) == (has(variables.old_status.blueGreen) ? variables.old_status.blueGreen : null) &&
          (has(variables.new_status.operationLock) ? variables.new_status.operationLock : null) == (has(variables.old_status.operationLock) ? variables.old_status.operationLock : null) &&
          (has(variables.new_status.breakGlass) ? variables.new_status.breakGlass : null) == (has(variables.old_status.breakGlass) ? variables.old_status.breakGlass : null) &&
          (has(variables.new_status.workload) ? variables.new_status.workload : null) == (has(variables.old_status.workload) ? variables.old_status.workload : null) &&
          (has(variables.new_status.adminOps) ? variables.new_status.adminOps : null) == (has(variables.old_status.adminOps) ? variables.old_status.adminOps : null) &&
          (has(variables.new_status.conditions) ? variables.new_status.conditions : []) == (has(variables.old_status.conditions) ? variables.old_status.conditions : []) &&
          has(variables.new_status.sentinel) &&
          (
            (!has(variables.old_status.sentinel) &&
              !has(variables.new_status.sentinel.lastHandledTriggerID) &&
              !has(variables.new_status.sentinel.lastHandledAt)
            ) ||
            (has(variables.old_status.sentinel) &&
              ((!has(variables.new_status.sentinel.lastHandledTriggerID) && !has(variables.old_status.sentinel.lastHandledTriggerID)) ||
                (has(variables.new_status.sentinel.lastHandledTriggerID) && has(variables.old_status.sentinel.lastHandledTriggerID) &&
                  variables.new_status.sentinel.lastHandledTriggerID == variables.old_status.sentinel.lastHandledTriggerID)) &&
              ((!has(variables.new_status.sentinel.lastHandledAt) && !has(variables.old_status.sentinel.lastHandledAt)) ||
                (has(variables.new_status.sentinel.lastHandledAt) && has(variables.old_status.sentinel.lastHandledAt) &&
                  variables.new_status.sentinel.lastHandledAt == variables.old_status.sentinel.lastHandledAt))
            )
          )
        )
      message: The Sentinel may only update status.sentinel trigger fields (triggerID/triggeredAt/triggerResource). Spec, metadata, and all other status fields are forbidden.
  variables:
    - expression: request.userInfo.username.startsWith("system:serviceaccount:") && request.userInfo.username.endsWith(":openbao-sentinel")
      name: is_sentinel
    - expression: 'has(object.status) ? object.status : object'
      name: new_status
    - expression: 'has(oldObject.status) ? oldObject.status : oldObject'
      name: old_status
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ include "openbao-operator.fullname" . }}-restrict-sentinel-mutations
  labels:
    {{- include "openbao-operator.labels" . | nindent 4 }}
spec:
  policyName: {{ include "openbao-operator.fullname" . }}-restrict-sentinel-mutations
  validationActions:
    - Deny
{{- end }}

