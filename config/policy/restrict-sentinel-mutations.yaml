apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: openbao-restrict-sentinel-mutations
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["openbao.org"]
        apiVersions: ["v1alpha1"]
        operations: ["UPDATE"]
        resources: ["openbaoclusters/status"]
  variables:
    - name: is_sentinel
      # Matches the ServiceAccount created in the tenant namespace
      # Kubernetes ServiceAccount usernames follow format: system:serviceaccount:<namespace>:<name>
      expression: >-
        request.userInfo.username.startsWith("system:serviceaccount:") &&
        request.userInfo.username.endsWith(":openbao-sentinel")
  validations:
    # Sentinel may only update status.sentinel trigger fields (GitOps-friendly).
    # Everything else (spec, metadata, other status) must remain unchanged.
    - expression: >-
        !variables.is_sentinel ||
        (
          # Spec must not change.
          object.spec == oldObject.spec &&
          # Metadata must not change.
          ((!has(object.metadata.labels) && !has(oldObject.metadata.labels)) ||
           (has(object.metadata.labels) && has(oldObject.metadata.labels) && object.metadata.labels == oldObject.metadata.labels)) &&
          ((!has(object.metadata.annotations) && !has(oldObject.metadata.annotations)) ||
           (has(object.metadata.annotations) && has(oldObject.metadata.annotations) && object.metadata.annotations == oldObject.metadata.annotations)) &&
          ((!has(object.metadata.finalizers) && !has(oldObject.metadata.finalizers)) ||
           (has(object.metadata.finalizers) && has(oldObject.metadata.finalizers) && object.metadata.finalizers == oldObject.metadata.finalizers)) &&

          # All non-sentinel status fields must remain unchanged.
          object.status.phase == oldObject.status.phase &&
          object.status.activeLeader == oldObject.status.activeLeader &&
          object.status.readyReplicas == oldObject.status.readyReplicas &&
          object.status.currentVersion == oldObject.status.currentVersion &&
          object.status.initialized == oldObject.status.initialized &&
          object.status.selfInitialized == oldObject.status.selfInitialized &&
          object.status.lastBackupTime == oldObject.status.lastBackupTime &&
          object.status.upgrade == oldObject.status.upgrade &&
          object.status.backup == oldObject.status.backup &&
          object.status.drift == oldObject.status.drift &&
          object.status.blueGreen == oldObject.status.blueGreen &&
          object.status.operationLock == oldObject.status.operationLock &&
          object.status.breakGlass == oldObject.status.breakGlass &&
          object.status.conditions == oldObject.status.conditions &&

          # Sentinel status: allow only trigger fields to change.
          has(object.status.sentinel) &&
          (
            # Operator-owned fields must not be changed by Sentinel.
            (!has(oldObject.status.sentinel) &&
              !has(object.status.sentinel.lastHandledTriggerID) &&
              !has(object.status.sentinel.lastHandledAt)
            ) ||
            (has(oldObject.status.sentinel) &&
              object.status.sentinel.lastHandledTriggerID == oldObject.status.sentinel.lastHandledTriggerID &&
              object.status.sentinel.lastHandledAt == oldObject.status.sentinel.lastHandledAt
            )
          )
        )
      message: "The Sentinel may only update status.sentinel trigger fields (triggerID/triggeredAt/triggerResource). Spec, metadata, and all other status fields are forbidden."
