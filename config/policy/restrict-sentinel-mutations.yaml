apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: openbao-restrict-sentinel-mutations
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["openbao.org"]
        apiVersions: ["v1alpha1"]
        operations: ["UPDATE"]
        resources: ["openbaoclusters"]
  variables:
    - name: is_sentinel
      # Matches the ServiceAccount created in the tenant namespace
      # Kubernetes ServiceAccount usernames follow format: system:serviceaccount:<namespace>:<name>
      expression: >-
        request.userInfo.username.startsWith("system:serviceaccount:") &&
        request.userInfo.username.endsWith(":openbao-sentinel")
  validations:
    # 1. Block Spec Changes: Sentinel cannot change the desired state.
    - expression: >-
        !variables.is_sentinel || object.spec == oldObject.spec
      message: "The Sentinel is not authorized to modify the OpenBaoCluster Spec."

    # 2. Block Status Changes: Sentinel cannot confuse the operator's status logic.
    # Uses has() to safely check for optional status field before accessing it.
    - expression: >-
        !variables.is_sentinel ||
        (has(object.status) == has(oldObject.status) &&
         (!has(object.status) || object.status == oldObject.status))
      message: "The Sentinel is not authorized to modify the OpenBaoCluster Status."

    # 3. Allow Annotations: Only specific sentinel annotations can be added/updated.
    # SECURITY FIX: Previous size-based check allowed "Piggyback" attacks where Sentinel
    # could modify existing annotations while adding the trigger. This new logic ensures:
    # - All existing annotations must remain unchanged (same key-value pairs)
    # - Only openbao.org/sentinel-trigger* annotations can be added or updated
    # - No annotations can be removed
    - expression: >-
        !variables.is_sentinel ||
        (
          ((!has(object.metadata.labels) && !has(oldObject.metadata.labels)) ||
           (has(object.metadata.labels) && has(oldObject.metadata.labels) && object.metadata.labels == oldObject.metadata.labels)) &&
          ((!has(object.metadata.finalizers) && !has(oldObject.metadata.finalizers)) ||
           (has(object.metadata.finalizers) && has(oldObject.metadata.finalizers) && object.metadata.finalizers == oldObject.metadata.finalizers)) &&
          (
            ((!has(object.metadata.annotations) && !has(oldObject.metadata.annotations)) ||
             (has(object.metadata.annotations) && has(oldObject.metadata.annotations) && object.metadata.annotations == oldObject.metadata.annotations)) ||
            (has(object.metadata.annotations) &&
             "openbao.org/sentinel-trigger" in object.metadata.annotations &&
             object.metadata.annotations.all(k,
               (has(oldObject.metadata.annotations) && k in oldObject.metadata.annotations &&
                object.metadata.annotations[k] == oldObject.metadata.annotations[k]) ||
               k == "openbao.org/sentinel-trigger" ||
               k == "openbao.org/sentinel-trigger-resource"
             ) &&
             (!has(oldObject.metadata.annotations) ||
              oldObject.metadata.annotations.all(k, k in object.metadata.annotations))
            )
          )
        )
      message: "The Sentinel can only add or update the openbao.org/sentinel-trigger and openbao.org/sentinel-trigger-resource annotations. All other metadata changes are forbidden."
