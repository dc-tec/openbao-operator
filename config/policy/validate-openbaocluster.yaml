apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: validate-openbaocluster
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["openbao.org"]
        apiVersions: ["v1alpha1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["openbaoclusters"]
  variables:
    - name: has_backup
      expression: has(object.spec.backup)
  validations:
    - expression: >-
        object.spec.profile != "Hardened" ||
        (object.spec.tls.mode in ["External", "ACME"] &&
          has(object.spec.unseal) &&
          object.spec.unseal.type != "static" &&
          has(object.spec.selfInit) &&
          object.spec.selfInit.enabled == true &&
          !(has(object.spec.unseal.transit) && has(object.spec.unseal.transit.tlsSkipVerify) && object.spec.unseal.transit.tlsSkipVerify == true) &&
          !(has(object.spec.unseal.kmip) && has(object.spec.unseal.kmip.tlsSkipVerify) && object.spec.unseal.kmip.tlsSkipVerify == true))
      message: Hardened profile requires TLS mode External or ACME, an external unseal (non-static), self-init enabled, and disallows tlsSkipVerify=true in seal configuration.
    - expression: >-
        has(object.spec.initContainer) &&
        object.spec.initContainer.enabled == true &&
        object.spec.initContainer.image != ""
      message: spec.initContainer is required, must be enabled, and must specify a non-empty image.
    - expression: >-
        !has(object.spec.selfInit) ||
        object.spec.selfInit.enabled == false ||
        (has(object.spec.selfInit.requests) && size(object.spec.selfInit.requests) > 0)
      message: spec.selfInit.requests is required and must not be empty when spec.selfInit.enabled is true.
    - expression: >-
        !has(object.spec.selfInit) ||
        object.spec.selfInit.enabled == false ||
        (!has(object.spec.selfInit.requests) ||
          (size(object.spec.selfInit.requests) <= 64 &&
            object.spec.selfInit.requests.all(r,
              object.spec.selfInit.requests.filter(x, x.name == r.name).size() == 1) &&
            object.spec.selfInit.requests.all(r, size(r.path) <= 256)))
      message: spec.selfInit.requests must have unique names (max 64) and request paths must be <= 256 characters.
    - expression: >-
        !has(object.spec.gateway) ||
        object.spec.gateway.enabled == false ||
        (object.spec.gateway.hostname != "" && object.spec.gateway.gatewayRef.name != "")
      message: spec.gateway.hostname and spec.gateway.gatewayRef.name are required when Gateway is enabled.
    - expression: >-
        !variables.has_backup ||
        (object.spec.backup.schedule != "" &&
          object.spec.backup.executorImage != "" &&
          (object.spec.backup.jwtAuthRole != "" || has(object.spec.backup.tokenSecretRef)) &&
          (object.spec.backup.target.roleArn != "" || has(object.spec.backup.target.credentialsSecretRef)) &&
          object.spec.backup.schedule.matches("^\\S+\\s+\\S+\\s+\\S+\\s+\\S+\\s+\\S+$"))
      message: spec.backup requires schedule, executorImage, OpenBao auth (jwtAuthRole or tokenSecretRef), storage auth (target.roleArn or target.credentialsSecretRef), and a 5-field cron expression.
