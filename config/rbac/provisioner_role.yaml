apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: openbao-operator-provisioner-role
  labels:
    app.kubernetes.io/name: openbao-operator
    app.kubernetes.io/component: provisioner
    app.kubernetes.io/managed-by: kustomize
rules:
  # 1. Namespace Watching (Required for Provisioner to detect tenants)
  - apiGroups:
      - ""
    resources:
      - namespaces
    verbs:
      - get
      - list
      - watch

  # 2. RBAC Management (Required to grant permissions to Tenants)
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - roles
      - rolebindings
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete

  # 3. Workload Management (Permissions granted to Tenants)
  # StatefulSets: Full access required to manage the cluster workload
  - apiGroups:
      - apps
    resources:
      - statefulsets
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # 4. Core Resources
  # Services, ConfigMaps, ServiceAccounts: Full management access
  - apiGroups:
      - ""
    resources:
      - configmaps
      - serviceaccounts
      - services
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # 5. Secret Access (HARDENED)
  # REMOVED: "list", "watch", "deletecollection"
  # RATIONALE: Prevents the operator (or an attacker) from listing all secrets.
  # The operator must know the exact name of the secret (e.g. 'my-cluster-unseal-key') to access it.
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - create
      - delete
      - get
      - patch
      - update

  # 6. Pod Access
  # REMOVED: "create", "delete" (Managed via StatefulSet controller)
  # KEPT: "update", "patch" (For label/annotation updates like TLS reload)
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - watch
      - update
      - patch

  # 7. PVC Access
  # Required for VolumeClaimTemplate management and cleanup
  - apiGroups:
      - ""
    resources:
      - persistentvolumeclaims
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # 8. Discovery
  - apiGroups:
      - ""
    resources:
      - endpoints
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - discovery.k8s.io
    resources:
      - endpointslices
    verbs:
      - get
      - list
      - watch

  # 9. OpenBao Custom Resources
  - apiGroups:
      - openbao.org
    resources:
      - openbaoclusters
      - openbaoclusters/status
      - openbaoclusters/finalizers
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # 10. Batch Jobs (For Backups)
  - apiGroups:
      - batch
    resources:
      - jobs
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # 11. Networking (Ingress & NetworkPolicy)
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
      - networkpolicies
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # 12. Gateway API
  - apiGroups:
      - gateway.networking.k8s.io
    resources:
      - httproutes
      - tlsroutes
      - backendtlspolicies
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
