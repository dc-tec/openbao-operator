---
# [SECURITY NOTICE]
# This ClusterRole defines the MAXIMUM permissions that can be delegated to a Tenant.
# It is bound to the 'delegate' ServiceAccount, which is never used directly.
# The Provisioner impersonates this account ONLY to create scoped Roles in Tenant namespaces.
#
# Trivy/Scanner Alerts regarding Secret/Role access here are FALSE POSITIVES relative to
# the architecture: these permissions are required to satisfy Kubernetes RBAC escalation
# checks when generating tenant-scoped policies.
#
# Architecture Context:
# - Delegation: The Provisioner uses 'impersonate' to create Roles for tenants.
# - K8s RBAC Rule: A user (or ServiceAccount) cannot create a Role granting permissions
#   they do not possess themselves.
# - Conclusion: The Delegate *must* hold the union of all permissions that *any* tenant
#   might need. Removing "Secrets" access here would prevent the operator from allowing
#   Tenants to manage their own secrets.
#
# Template ClusterRole that defines exactly what a tenant should be allowed to do.
# This is bound to the delegate ServiceAccount, which the Provisioner impersonates
# when creating tenant Roles/RoleBindings. The API server enforces that the delegate
# can only create Roles with permissions it itself possesses.
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: openbao-operator-tenant-template
  labels:
    app.kubernetes.io/name: openbao-operator
    app.kubernetes.io/component: provisioner
    app.kubernetes.io/managed-by: kustomize
rules:
  # Permission to create Roles and RoleBindings (required to grant permissions)
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - roles
      - rolebindings
    verbs:
      - delete
      - create
      - get
      - list
      - patch
      - update
      - watch
  # Tenant permissions that can be granted (matches GenerateTenantRole)
  - apiGroups:
      - openbao.org
    resources:
      - openbaoclusters
      - openbaoclusters/status
      - openbaoclusters/finalizers
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - openbao.org
    resources:
      - openbaorestores
      - openbaorestores/status
      - openbaorestores/finalizers
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - apps
    resources:
      - statefulsets
      - deployments
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - services
      - configmaps
      - serviceaccounts
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - create
      - delete
      - get
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - patch
      - update
      - watch
      - delete
  - apiGroups:
      - ""
    resources:
      - persistentvolumeclaims
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - batch
    resources:
      - jobs
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  # PodDisruptionBudgets for StatefulSet protection during disruptions
  - apiGroups:
      - policy
    resources:
      - poddisruptionbudgets
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
      - networkpolicies
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - gateway.networking.k8s.io
    resources:
      - httproutes
      - tlsroutes
      - backendtlspolicies
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - endpoints
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - discovery.k8s.io
    resources:
      - endpointslices
    verbs:
      - get
      - list
      - watch
