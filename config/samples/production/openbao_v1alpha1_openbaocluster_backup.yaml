# OpenBaoCluster with Backup Configuration
#
# This example demonstrates scheduled backups of OpenBao Raft snapshots to
# object storage. Backups are executed using Kubernetes Jobs with a dedicated
# backup executor container.
#
# Supported Storage Providers:
# - S3: AWS S3 or S3-compatible storage (MinIO, Ceph, etc.)
# - GCS: Google Cloud Storage
# - Azure: Azure Blob Storage
#
# Prerequisites:
# - Object storage bucket/container configured
# - Credentials Secret (provider-specific keys)
# - JWT authentication enabled in OpenBao (for JWT Auth method)
#   OR a backup token Secret (for static token method)
#
# See: docs/user-guide/openbaocluster/operations/backups.md
apiVersion: openbao.org/v1alpha1
kind: OpenBaoCluster
metadata:
  labels:
    app.kubernetes.io/name: openbao-operator
    app.kubernetes.io/managed-by: kustomize
  name: openbaocluster-backup
spec:
  version: "2.4.4"
  replicas: 3
  profile: Development
  tls:
    enabled: true
    rotationPeriod: "720h"
  storage:
    size: "10Gi"
  deletionPolicy: Retain
  # Structured configuration
  configuration:
    logLevel: "info"
    ui: true
    logging:
      format: "json"
      file: "/var/log/openbao/openbao.log"
      rotateDuration: "24h"
      rotateBytes: 10485760 # 10MB
      rotateMaxFiles: 7
  # Self-initialization with backup policy (for JWT Auth)
  # Note: For Hardened profile clusters, backup and upgrade policies/roles are
  # automatically created when spec.backup.jwtAuthRole and spec.upgrade.jwtAuthRole
  # are configured. This example shows manual configuration for non-Hardened clusters.
  selfInit:
    enabled: true
    requests:
      # Enable JWT authentication (or opt-in to bootstrap via spec.selfInit.oidc.enabled: true)
      - name: enable-jwt-auth
        operation: update
        path: sys/auth/jwt
        authMethod:
          type: jwt
      # Configure JWT auth with OIDC
      - name: configure-jwt-auth
        operation: update
        path: auth/jwt/config
        data:
          oidc_discovery_url: "https://kubernetes.default.svc"
          oidc_discovery_ca_pem: "<K8S_CA_PEM>"
          bound_issuer: "https://kubernetes.default.svc"
      # Create backup policy with read access to sys/storage/raft/snapshot
      - name: create-backup-policy
        operation: update
        path: sys/policies/acl/backup
        policy:
          policy: |
            path "sys/storage/raft/snapshot" {
              capabilities = ["read"]
            }
      # Create JWT Auth role for backup operations
      # The ServiceAccount name is automatically <cluster-name>-backup-serviceaccount
      - name: create-backup-jwt-role
        operation: update
        path: auth/jwt/role/backup
        data:
          role_type: jwt
          bound_audiences: ["openbao-internal"]
          bound_claims:
            kubernetes.io/namespace: openbaocluster-backup
            kubernetes.io/serviceaccount/name: openbaocluster-backup-backup-serviceaccount
          token_policies: backup
          ttl: 1h
  # Scheduled backups configuration
  backup:
    schedule: "0 3 * * *" # Daily at 3 AM
    executorImage: "openbao/backup-executor:v0.1.0" # Default, can be omitted
    target:
      # Storage provider: s3 (default), gcs, or azure
      provider: s3
      endpoint: "https://s3.amazonaws.com"
      bucket: "openbao-backups"
      pathPrefix: "clusters/openbaocluster-backup"
      # S3-specific options
      region: "us-east-1"
      usePathStyle: false  # Set true for MinIO/S3-compatible stores
      # Optional: IAM Role ARN for Web Identity (IRSA) - no Secret needed
      # roleArn: "arn:aws:iam::123456789012:role/openbao-backup"
      credentialsSecretRef:
        name: s3-backup-credentials
      # Optional: Tune multipart upload performance
      # partSize: 10485760  # 10MB (default) - larger values may improve performance on fast networks
      # concurrency: 3  # Default - higher values may improve throughput but increase memory usage
    # JWT Auth (preferred - automatically rotated tokens)
    jwtAuthRole: backup
    # Alternative: Static token (for self-init clusters without JWT Auth)
    # tokenSecretRef:
    #   name: backup-token-secret
    # Retention policy: keep up to 7 backups and at most 7 days of history
    retention:
      maxCount: 7
      maxAge: "168h" # 7 days
---
# Example: S3 credentials Secret
# apiVersion: v1
# kind: Secret
# metadata:
#   name: s3-backup-credentials
# type: Opaque
# stringData:
#   accessKeyId: "YOUR_ACCESS_KEY_ID"
#   secretAccessKey: "YOUR_SECRET_ACCESS_KEY"
#   # Optional:
#   # region: "us-east-1"
#   # sessionToken: "YOUR_SESSION_TOKEN"  # For temporary credentials
#   # caCert: |  # For self-signed certificates
#   #   -----BEGIN CERTIFICATE-----
#   #   ...
#   #   -----END CERTIFICATE-----
---
# Example: GCS configuration
# apiVersion: openbao.org/v1alpha1
# kind: OpenBaoCluster
# metadata:
#   name: openbaocluster-backup-gcs
# spec:
#   # ... (same as above)
#   backup:
#     schedule: "0 3 * * *"
#     jwtAuthRole: backup
#     target:
#       provider: gcs
#       bucket: "openbao-backups"
#       pathPrefix: "clusters/openbaocluster-backup-gcs"
#       gcs:
#         project: "my-gcp-project"  # Optional if using ADC
#       credentialsSecretRef:
#         name: gcs-backup-credentials
#     retention:
#       maxCount: 7
#       maxAge: "168h"
# ---
# Example: GCS credentials Secret (service account JSON)
# apiVersion: v1
# kind: Secret
# metadata:
#   name: gcs-backup-credentials
# type: Opaque
# stringData:
#   credentials.json: |
#     {
#       "type": "service_account",
#       "project_id": "my-gcp-project",
#       ...
#     }
# Note: For Workload Identity or GKE, omit credentialsSecretRef to use ADC
---
# Example: Azure configuration
# apiVersion: openbao.org/v1alpha1
# kind: OpenBaoCluster
# metadata:
#   name: openbaocluster-backup-azure
# spec:
#   # ... (same as above)
#   backup:
#     schedule: "0 3 * * *"
#     jwtAuthRole: backup
#     target:
#       provider: azure
#       bucket: "openbao-backups"  # Container name
#       pathPrefix: "clusters/openbaocluster-backup-azure"
#       azure:
#         storageAccount: "mystorageaccount"
#         container: "openbao-backups"  # Optional, uses bucket if omitted
#       credentialsSecretRef:
#         name: azure-backup-credentials
#     retention:
#       maxCount: 7
#       maxAge: "168h"
# ---
# Example: Azure credentials Secret (use accountKey OR connectionString)
# apiVersion: v1
# kind: Secret
# metadata:
#   name: azure-backup-credentials
# type: Opaque
# stringData:
#   # Option 1: Account Key
#   accountKey: "YOUR_STORAGE_ACCOUNT_KEY"
#   # Option 2: Connection String (alternative to accountKey)
#   # connectionString: "DefaultEndpointsProtocol=https;AccountName=..."
# Note: For AKS managed identity, omit credentialsSecretRef
