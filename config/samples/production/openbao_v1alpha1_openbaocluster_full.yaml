#apiVersion: cert-manager.io/v1
#kind: Issuer
#metadata:
#  name: bao-gateway-selfsigned-issuer
#  namespace: openbaocluster-full
#spec:
#  selfSigned: {}
#---
## CA Certificate for OpenBao cluster TLS
#apiVersion: cert-manager.io/v1
#kind: Certificate
#metadata:
#  name: openbaocluster-full-tls-ca
#  namespace: openbaocluster-full
#spec:
#  secretName: openbaocluster-full-tls-ca
#  issuerRef:
#    kind: Issuer
#    name: bao-gateway-selfsigned-issuer
#  commonName: openbaocluster-full-ca
#  isCA: true
#---
## Server Certificate for OpenBao cluster TLS
#apiVersion: cert-manager.io/v1
#kind: Certificate
#metadata:
#  name: openbaocluster-full-tls-server
#  namespace: openbaocluster-full
#spec:
#  secretName: openbaocluster-full-tls-server
#  dnsNames:
#    - openbaocluster-full.openbaocluster-full.svc
#    - "*.openbaocluster-full.openbaocluster-full.svc"
#    - openbaocluster-full-public.openbaocluster-full.svc
#    - bao-full.adfinis.localhost
#  issuerRef:
#    kind: Issuer
#    name: bao-gateway-selfsigned-issuer
#---
# Gateway Certificate (for Gateway HTTPS listener)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: bao-gateway-cert
  namespace: openbaocluster-full
spec:
  # This secret is referenced by the Gateway HTTPS listener (certificateRefs.name: bao-tls).
  secretName: bao-tls
  dnsNames:
    - bao-full.adfinis.localhost
  issuerRef:
    kind: Issuer
    name: bao-gateway-selfsigned-issuer
---
apiVersion: v1
kind: Secret
metadata:
  name: rustfs-secret
  namespace: openbaocluster-full
type: Opaque
data:
  accessKeyId: cnVzdGZzYWRtaW4= # rustfsadmin
  secretAccessKey: cnVzdGZzYWRtaW4= # rustfsadmin
---
# OpenBaoCluster with Hardened Profile:
# - Hardened security profile (required for production)
# - External TLS management (cert-manager)
# - External KMS auto-unseal (AWS KMS)
# - Self-initialization enabled (no root token)
# - JWT authentication (opt-in via spec.selfInit.oidc.enabled)
# - Gateway API for external access
# - Scheduled backups to RustFS (S3-compatible storage)
# - Backup and upgrade policies/roles automatically created
#
# Notes:
# - This example assumes:
#   * A Gateway controller is installed and managing a Gateway named "traefik-gateway" in the "default" namespace.
#   * RustFS is installed via the rustfs-helm chart using test/cluster/rustfs-values.yaml.
#   * AWS KMS key is available (or update unseal configuration for your environment).
# - Backups target the in-cluster RustFS Service endpoint:
#     http://rustfs-svc.rustfs.svc.cluster.local:9000
apiVersion: openbao.org/v1alpha1
kind: OpenBaoCluster
metadata:
  namespace: openbaocluster-full
  labels:
    app.kubernetes.io/name: openbao-operator
    app.kubernetes.io/managed-by: kustomize
  name: openbaocluster-full
spec:
  # Hardened security profile - REQUIRED for production
  profile: Development
  workloadHardening:
    appArmorEnabled: false
  configuration:
    logLevel: "debug"
    # UI enabled for management interface
    ui: true
    # Structured logging configuration
    logging:
      format: "json"
      file: "/var/log/openbao/openbao.log"
      rotateDuration: "24h"
      rotateBytes: 10485760 # 10MB
      rotateMaxFiles: 7
      pidFile: "/var/run/openbao/openbao.pid"
    # Plugin configuration
    plugin:
      autoDownload: true
      autoRegister: false
      downloadBehavior: "direct"
      fileUID: 1000
      filePermissions: "0755"
    # Lease/TTL configuration
    defaultLeaseTTL: "720h" # 30 days
    maxLeaseTTL: "8760h" # 1 year
    # Cache configuration
    cacheSize: 134217728 # 128MB
    disableCache: false
    # Raft performance tuning
    raft:
      performanceMultiplier: 2
  version: "2.4.4"
  # image: "openbao/openbao:2.4.4" # Optional: inferred from version
  # Image Verification (Supply Chain Security)
  # The operator verifies container image signatures using Cosign before deployment.
  # By default, signatures are verified against the Rekor transparency log for non-repudiation.
  # The operator resolves image tags to digests during verification and uses the verified
  # digest in operator-managed workloads (StatefulSets/Deployments/Jobs) to prevent TOCTOU
  # (Time-of-Check to Time-of-Use) attacks.
  #
  # imageVerification: Verifies the main OpenBao server image (openbao/openbao).
  # operatorImageVerification: Verifies operator-provided helper images (init container,
  #   backup executor, upgrade executor, etc.). If not specified, falls back
  #   to imageVerification.
  imageVerification:
    enabled: true
    issuer: "https://token.actions.githubusercontent.com"
    # For official OpenBao images, use the OpenBao project's workflow:
    # subject: "https://github.com/openbao/openbao/.github/workflows/release.yml@refs/tags/v2.4.4"
    # For development/testing with operator-signed images:
    subject: "https://github.com/dc-tec/openbao-operator/.github/workflows/release.yml@refs/tags/2.4.4"
    # PEM-encoded Cosign public key for signature verification.
    # Download the official OpenBao public key from: https://openbao.org/docs/install/#cosign-and-rekor
    # publicKey: |
    #   -----BEGIN PUBLIC KEY-----
    #   MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...
    #   -----END PUBLIC KEY-----
    failurePolicy: Block # "Block" prevents deployment on failure; "Warn" logs but proceeds
    # ignoreTlog: false  # Set to true to disable Rekor transparency log verification (not recommended)
    # imagePullSecrets:  # Optional: List of ImagePullSecrets for private registry authentication
    #   - name: registry-credentials  # Secret type: kubernetes.io/dockerconfigjson
  # Separate verification for operator images (independent - no fallback to imageVerification)
  # If not configured, helper images are NOT verified even if imageVerification is set.
  # operatorImageVerification:
  #   enabled: true
  #   issuer: "https://token.actions.githubusercontent.com"
  #   subject: "https://github.com/dc-tec/openbao-operator/.github/workflows/release.yml@refs/tags/1.2.4"
  #   failurePolicy: Block
  initContainer:
    enabled: true
    # For k3d clusters, use the k3d registry path: k3d-registry.localhost:5000/openbao-init:dev
    # For other environments, use a fully qualified image reference
    image: "k3d-registry.localhost:5000/openbao-init:1.2.4"
  network:
    apiServerCIDR: "10.43.0.0/16"
    apiServerEndpointIPs:
      - "192.168.166.2"
  replicas: 3
  # External TLS management (required for Hardened profile)
  # The operator expects these Secrets to exist (created by cert-manager above):
  # - openbaocluster-full-tls-ca: CA certificate Secret
  # - openbaocluster-full-tls-server: Server certificate Secret
  tls:
    enabled: true
    mode: OperatorManaged # External is required for Hardened profile
    rotationPeriod: "720h"
  storage:
    size: "10Gi"
  deletionPolicy: DeleteAll
  # External KMS auto-unseal (required for Hardened profile)
  # No static unseal key Secret is created - the root of trust is the KMS service
  # unseal:
  #   type: awskms # Required: external KMS only (awskms, gcpckms, azurekeyvault, transit, kmip, ocikms, or pkcs11)
  #   awskms:
  #     region: us-east-1
  #     kmsKeyID: alias/openbao-unseal
  #     # Optional: Custom KMS endpoint (for VPC endpoints)
  #     # endpoint: "https://kms.us-east-1.amazonaws.com"
  #   # Optional: If not using IRSA (IAM Roles for Service Accounts)
  #   # credentialsSecretRef:
  #   #   name: aws-kms-credentials
  #   #   namespace: openbaocluster-full

  # Self-initialization configuration (required for Hardened profile)
  # OIDC bootstrap (opt-in)
  # Set spec.selfInit.oidc.enabled: true to have the operator automatically configure
  # JWT auth, OIDC discovery, operator policy/role, and backup/upgrade policies/roles.
  # Backup and upgrade policies/roles are also automatically created when
  # spec.backup.jwtAuthRole and spec.upgrade.jwtAuthRole are configured
  selfInit:
    enabled: true # Required for Hardened profile
    # Opt-in to JWT bootstrap to automatically configure JWT auth, OIDC, and policies/roles
    # This enables the operator to authenticate via JWT and automatically creates
    # backup/upgrade policies and roles when spec.backup.jwtAuthRole and spec.upgrade.jwtAuthRole are set
    oidc:
      enabled: true
    requests:
      # Enable stdout audit logging (useful for debugging)
      # - name: enable-stdout-audit
      #   operation: update
      #   path: sys/audit/stdout
      #   auditDevice:
      #     type: file
      #     fileOptions:
      #       filePath: stdout
      # Create an "admin" policy with broad permissions (similar to root).
      # This policy can be attached to tokens or identities created out-of-band.
      - name: create-admin-policy
        operation: update
        path: sys/policies/acl/admin
        policy:
          policy: |
            path "*" {
              capabilities = ["create", "read", "update", "delete", "list", "sudo"]
            }

  # Gateway API configuration (based on openbao_v1alpha1_openbaocluster_gateway.yaml).
  gateway:
    enabled: true
    gatewayRef:
      # Reference to an existing Gateway resource managed by Traefik (or other controller).
      name: traefik-gateway
      namespace: default
    # Hostname for routing traffic to this OpenBao cluster.
    # This will be automatically added to the server certificate SANs.
    hostname: bao-full.adfinis.localhost
    backendTLS:
      enabled: true
    # TLS passthrough mode using TLSRoute instead of HTTPRoute.
    tlsPassthrough: false
    # Optional path prefix (defaults to "/").
    path: /
    # Optional annotations for the HTTPRoute.
    annotations:
      bao-full.adfinis.localhost/backend-protocol: HTTPS

  upgrade:
    #jwtAuthRole: upgrade
    # Take a snapshot before any version upgrade.
    preUpgradeSnapshot: true

  # Scheduled backups to RustFS (S3-compatible storage).
  backup:
    # Run a backup every 15 minutes
    schedule: "*/15 * * * *"
    # Backup image built from Dockerfile.backup in this repository.
    # For k3d clusters, push to the local registry; for other environments,
    # use a fully qualified image reference.
    image: "k3d-registry.localhost:5000/openbao-backup:1.1.0"
    target:
      # RustFS S3 API endpoint inside the cluster.
      # Use the internal ClusterIP service for in-cluster access (recommended).
      # This avoids Ingress TLS/certificate issues and is more efficient.
      # Alternative: Use Ingress endpoint "https://rustfs.adfinis.localhost" if accessing from outside cluster.
      endpoint: "http://rustfs-svc.rustfs.svc.cluster.local:9000"
      # Bucket name to store backups in RustFS.
      bucket: "openbao-backups"
      # Optional prefix within the bucket for this cluster's backups.
      # The full path will be: <pathPrefix>/<namespace>/<cluster>/<timestamp>-<uuid>.snap
      # Example: clusters/openbaocluster-full/openbaocluster-full/2025-12-07T10-45-32Z-21d31dd7.snap
      pathPrefix: "clusters"
      # Use path-style addressing (required for S3-compatible stores like RustFS).
      # When false, the SDK uses virtual-hosted-style (bucket.endpoint), which causes DNS issues.
      usePathStyle: true
      # Reference to the Secret containing S3 credentials.
      # Secret must be in the same namespace as the OpenBaoCluster.
      # For self-signed certificates, add the CA certificate to the Secret with key "caCert":
      #   kubectl create secret generic rustfs-secret \
      #     --from-literal=accessKeyId=<key> \
      #     --from-literal=secretAccessKey=<secret> \
      #     --from-file=caCert=/path/to/ca.crt \
      #     -n <namespace>
      credentialsSecretRef:
        name: rustfs-secret
    # Authentication method for backup operations.
    # JWT Auth (preferred - automatically rotated tokens, better security)
    # For Hardened profile, backup policy and role are automatically created
    # jwtAuthRole: backup
    # Fallback: Static token (only used if jwtAuthRole is not set)
    # For self-init clusters without JWT Auth, configure a dedicated
    # backup token Secret with a token that has `read` access to
    # sys/storage/raft/snapshot.
    # tokenSecretRef:
    #   name: openbaocluster-full-backup-token
    #   namespace: openbao-operator-system
    # Retention policy: keep up to 7 backups and at most 7 days of history.
    retention:
      maxCount: 7
      maxAge: "168h"
