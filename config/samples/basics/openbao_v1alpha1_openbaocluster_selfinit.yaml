# OpenBaoCluster with Self-Initialization
#
# This example demonstrates OpenBao's self-initialization feature, which allows
# declarative cluster bootstrapping. When enabled:
# - OpenBao initializes itself automatically on first start
# - The root token is automatically revoked after initialization (not stored)
# - Initial configuration (audit devices, auth methods, etc.) is applied during init
#
# Requires OpenBao v2.4.0 or later.
# See: https://openbao.org/docs/configuration/self-init/
apiVersion: openbao.org/v1alpha1
kind: OpenBaoCluster
metadata:
  labels:
    app.kubernetes.io/name: openbao-operator
    app.kubernetes.io/managed-by: kustomize
  name: openbaocluster-selfinit
spec:
  version: "2.4.4"
  image: "openbao/openbao:2.4.4"
  replicas: 3
  profile: Development
  tls:
    enabled: true
    rotationPeriod: "720h"
  storage:
    size: "10Gi"
  deletionPolicy: Retain
  # Structured configuration
  configuration:
    logLevel: "info"
    ui: true
    logging:
      format: "standard"
      file: "/var/log/openbao/openbao.log"
  # Self-initialization configuration
  selfInit:
    enabled: true
    requests:
      # Enable stdout audit logging (useful for debugging)
      - name: enable-stdout-audit
        operation: update
        path: sys/audit/stdout
        auditDevice:
          type: file
          fileOptions:
            filePath: stdout
      # Enable Kubernetes authentication
      - name: enable-kubernetes-auth
        operation: update
        path: sys/auth/kubernetes
        authMethod:
          type: kubernetes
      # Configure Kubernetes auth to use in-cluster service account
      - name: configure-kubernetes-auth
        operation: update
        path: auth/kubernetes/config
        data:
          kubernetes_host: "https://kubernetes.default.svc"
