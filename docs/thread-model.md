# Threat Model: OpenBao Operator

## 1. Asset Identification
* **High Value:** Root CA Private Key (stored in Secret)..
* **Medium Value:** The OpenBao Configuration (ConfigMap).
* **High Value:** OpenBao Raft data on persistent volumes (PVCs).
* **High Value:** Backup snapshots stored in external object storage.
* **High Value:** Static auto-unseal key stored in Kubernetes Secret (per OpenBao cluster).
* **Medium Value:** Operator service account tokens and any credentials/secrets used to access object storage.
* **Medium Value:** `OpenBaoCluster` CRDs and their Status (can reveal topology and health).

## 2. Threat Analysis (STRIDE)

### A. Spoofing
* **Threat:** A rogue pod attempts to join the Raft cluster.
* **Mitigation:** We use strict mTLS. The Operator acts as the CA. Only pods with a valid certificate mounted via the Secret can join the mesh.

* **Threat:** An attacker spoofs external endpoints (Ingress/LoadBalancer) to intercept OpenBao traffic.
* **Mitigation:** Require TLS with correct SANs for all external hostnames; recommend NetworkPolicies and, where applicable, service mesh mTLS for north-south traffic.

### B. Tampering
* **Threat:** User manually edits the StatefulSet (e.g., changes image tag).
* **Mitigation:** The Operator's Reconciliation loop runs constantly. It will revert any out-of-band changes to the StatefulSet to match the CRD "Source of Truth" immediately.

* **Threat:** Malicious or misconfigured tenant modifies their `OpenBaoCluster` to point backups to an unauthorized object storage location.
* **Mitigation:** Backup target configuration can be constrained via admission control policies and/or namespace-scoped RBAC; operators should validate backup targets against an allowlist where required.

### C. Elevation of Privilege
* **Threat:** Attacker compromises the Operator Pod to gain control of the cluster.
* **Mitigation:**
    * Operator runs as non-root.
    * RBAC `ClusterRole` is scoped strictly to `openbao.org` resources, Secrets, and StatefulSets.
    * Operator does NOT have permission to read the *data* inside OpenBao (KV engine), only the API system endpoints.

* **Threat:** One tenant's `OpenBaoCluster` configuration impacts other clusters (cross-tenant impact).
* **Mitigation:** Operator implementation must fully qualify all resources with namespace/name and avoid sharing Secrets/ConfigMaps across clusters; RBAC can be configured so teams only manage clusters in their own namespaces.

### D. Information Disclosure
* **Threat:** TLS keys, backup credentials, or snapshot contents are exposed via logs or metrics.
* **Mitigation:** Never log secret material; use structured logging with careful redaction; encrypt Secrets at rest and enforce least-privilege RBAC; rely on OpenBao's telemetry parameters (not custom logging of sensitive fields).

* **Threat:** Unauthorized access to backups in object storage.
* **Mitigation:** Use storage-level encryption and strict access controls (per-tenant buckets/prefixes, scoped credentials); document best practices for platform teams.

* **Threat (Critical):** Compromise of Kubernetes Secrets storing the static auto-unseal key allows decryption of all OpenBao data for that cluster.
* **Mitigation:** Require etcd encryption at rest; strictly limit Secret access via RBAC; apply network and node hardening; enable audit logging for Secret access in the Kubernetes control plane.

### E. Denial of Service
* **Threat:** Misconfigured `OpenBaoCluster` resources cause hot reconcile loops that overload the Operator or API server.
* **Mitigation:** Implement reconciliation backoff, limit concurrent reconciles per cluster, and surface misconfiguration via Status conditions so users can remediate.

* **Threat:** Excessive backup frequency or large snapshot sizes exhaust object storage quotas or saturate network bandwidth.
* **Mitigation:** Validate backup schedules and document recommended limits; make backup settings configurable and observable.

### F. Repudiation
* **Threat:** Lack of audit trail for Operator-initiated actions (e.g., upgrades, step-downs, backups).
* **Mitigation:** Use structured, timestamped logs including `OpenBaoCluster` namespace/name and correlation IDs; rely on Kubernetes/audit logs and OpenBao audit logs where available.

## 3. Secrets Management
* **Requirement:** The CA Key generated by the Operator must never be logged to stdout/stderr.
* **Requirement:** Credentials and tokens used for object storage access must be stored in Kubernetes Secrets or via workload identity, never embedded in ConfigMaps or images.
* **Requirement:** Secret names must be unique per `OpenBaoCluster` to prevent accidental cross-tenant sharing.
