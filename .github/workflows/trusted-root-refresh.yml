name: Trusted Root Refresh

on:
  schedule:
    # Quarterly refresh (first day of each quarter at 03:17 UTC)
    - cron: "17 3 1 */3 *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: trusted-root-refresh
  cancel-in-progress: true

jobs:
  refresh:
    name: Refresh trusted_root.json
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true

      - name: Update trusted root
        run: |
          set -euo pipefail
          make update-trusted-root verify-trusted-root

      - name: Create PR if changed
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          branch: chore/update-trusted-root
          delete-branch: true
          title: "chore: update Sigstore trusted root"
          commit-message: "chore: update Sigstore trusted root"
          body: |
            Automated refresh of `internal/security/trusted_root.json`.

            - Generated by `.github/workflows/trusted-root-refresh.yml`
            - Validated with `make verify-trusted-root`
