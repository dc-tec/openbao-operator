name: Release

on:
  push:
    tags:
      - "[0-9]*.[0-9]*.[0-9]*"
      - "[0-9]*.[0-9]*.[0-9]*-*"
      # Match SemVer build metadata tags (e.g. 1.2.3+build.1). Use a character class
      # to avoid minimatch extglob parsing of '+'.
      - "[0-9]*.[0-9]*.[0-9]*[+]*"

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  artifact-metadata: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.vars.outputs.version }}
      chart_version: ${{ steps.vars.outputs.chart_version }}
      build_tag: ${{ steps.vars.outputs.build_tag }}
      manager_image: ${{ steps.vars.outputs.manager_image }}
      config_init_image: ${{ steps.vars.outputs.config_init_image }}
      backup_executor_image: ${{ steps.vars.outputs.backup_executor_image }}
      upgrade_executor_image: ${{ steps.vars.outputs.upgrade_executor_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 1

      - name: Compute release variables
        id: vars
        run: |
          set -euo pipefail
          version="${{ github.ref_name }}"
          if ! [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+([\-+].*)?$ ]]; then
            echo "version must be a semver tag (e.g., 0.1.0 or 0.1.0-rc.1)" >&2
            exit 1
          fi

          sha="$(git rev-parse HEAD)"
          build_tag="build-${sha}"

          owner="${GITHUB_REPOSITORY_OWNER}"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "chart_version=${version}" >> "${GITHUB_OUTPUT}"
          echo "build_tag=${build_tag}" >> "${GITHUB_OUTPUT}"

          echo "manager_image=ghcr.io/${owner}/openbao-operator" >> "${GITHUB_OUTPUT}"
          echo "config_init_image=ghcr.io/${owner}/openbao-init" >> "${GITHUB_OUTPUT}"
          echo "backup_executor_image=ghcr.io/${owner}/openbao-backup" >> "${GITHUB_OUTPUT}"
          echo "upgrade_executor_image=ghcr.io/${owner}/openbao-upgrade" >> "${GITHUB_OUTPUT}"

      - name: Fail fast if draft GitHub Release is missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          version="${{ steps.vars.outputs.version }}"
          for _ in $(seq 1 24); do
            if gh release view "${version}" >/dev/null 2>&1; then
              echo "Found GitHub Release ${version}"
              exit 0
            fi
            sleep 5
          done
          echo "GitHub Release '${version}' not found after waiting." >&2
          echo "Merge the release-please PR to create the tag and draft release." >&2
          exit 1

  build-images:
    name: Build Images (Build Tag)
    runs-on: ubuntu-24.04
    needs: prepare
    outputs:
      manager_digest: ${{ steps.build_manager.outputs.digest }}
      config_init_digest: ${{ steps.build_config_init.outputs.digest }}
      backup_executor_digest: ${{ steps.build_backup_executor.outputs.digest }}
      upgrade_executor_digest: ${{ steps.build_upgrade_executor.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build and push manager
        id: build_manager
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          provenance: false
          sbom: false
          tags: ${{ needs.prepare.outputs.manager_image }}:${{ needs.prepare.outputs.build_tag }}

      - name: Build and push config-init
        id: build_config_init
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Dockerfile.init
          platforms: linux/amd64,linux/arm64
          push: true
          provenance: false
          sbom: false
          tags: ${{ needs.prepare.outputs.config_init_image }}:${{ needs.prepare.outputs.build_tag }}

      - name: Build and push backup executor
        id: build_backup_executor
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Dockerfile.backup
          platforms: linux/amd64,linux/arm64
          push: true
          provenance: false
          sbom: false
          tags: ${{ needs.prepare.outputs.backup_executor_image }}:${{ needs.prepare.outputs.build_tag }}

      - name: Build and push upgrade executor
        id: build_upgrade_executor
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Dockerfile.upgrade
          platforms: linux/amd64,linux/arm64
          push: true
          provenance: false
          sbom: false
          tags: ${{ needs.prepare.outputs.upgrade_executor_image }}:${{ needs.prepare.outputs.build_tag }}

  security-govulncheck:
    name: Security Gate (govulncheck)
    runs-on: ubuntu-24.04
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true

      - name: Run govulncheck
        env:
          GOFLAGS: -mod=readonly
        run: |
          set -euo pipefail
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.4
          govulncheck -test ./...

  security-images:
    name: Security Gate (Trivy image ${{ matrix.image_name }})
    runs-on: ubuntu-24.04
    needs: [prepare, build-images]
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_name: manager
            image_ref: ${{ needs.prepare.outputs.manager_image }}:${{ needs.prepare.outputs.build_tag }}
          - image_name: config-init
            image_ref: ${{ needs.prepare.outputs.config_init_image }}:${{ needs.prepare.outputs.build_tag }}
          - image_name: backup-executor
            image_ref: ${{ needs.prepare.outputs.backup_executor_image }}:${{ needs.prepare.outputs.build_tag }}
          - image_name: upgrade-executor
            image_ref: ${{ needs.prepare.outputs.upgrade_executor_image }}:${{ needs.prepare.outputs.build_tag }}
    steps:
      - name: Login to GHCR (pull)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan image
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: image
          image-ref: ${{ matrix.image_ref }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"

  e2e:
    name: E2E Gate (kind ${{ matrix.k8s }})
    runs-on: ubuntu-24.04
    needs: [prepare, build-images]
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        k8s:
          - 1.33.7
          - 1.34.3
          - 1.35.0
    env:
      KIND_NODE_IMAGE: kindest/node:v${{ matrix.k8s }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true

      - name: Login to GHCR (pull)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install kind (pinned)
        uses: ./.github/actions/install-kind

      - name: Pull images (amd64) for kind load
        run: |
          set -euo pipefail
          docker pull "${{ needs.prepare.outputs.manager_image }}:${{ needs.prepare.outputs.build_tag }}"
          docker pull "${{ needs.prepare.outputs.config_init_image }}:${{ needs.prepare.outputs.build_tag }}"
          docker pull "${{ needs.prepare.outputs.backup_executor_image }}:${{ needs.prepare.outputs.build_tag }}"
          docker pull "${{ needs.prepare.outputs.upgrade_executor_image }}:${{ needs.prepare.outputs.build_tag }}"

      - name: Run full E2E
        env:
          GOFLAGS: -mod=readonly
          E2E_TIMEOUT: 90m
          E2E_PARALLEL_NODES: "2"
          E2E_SKIP_IMAGE_BUILD: "true"

          OPERATOR_VERSION: ${{ needs.prepare.outputs.build_tag }}

          E2E_OPERATOR_IMAGE: ${{ needs.prepare.outputs.manager_image }}:${{ needs.prepare.outputs.build_tag }}
          E2E_CONFIG_INIT_IMAGE: ${{ needs.prepare.outputs.config_init_image }}:${{ needs.prepare.outputs.build_tag }}
          E2E_BACKUP_EXECUTOR_IMAGE: ${{ needs.prepare.outputs.backup_executor_image }}:${{ needs.prepare.outputs.build_tag }}
          E2E_UPGRADE_EXECUTOR_IMAGE: ${{ needs.prepare.outputs.upgrade_executor_image }}:${{ needs.prepare.outputs.build_tag }}
        run: make test-e2e-ci

      - name: Collect E2E artifacts (failure)
        if: failure()
        run: bash hack/ci/collect-e2e-artifacts.sh

      - name: Upload E2E artifacts (failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-kind-${{ matrix.k8s }}
          path: artifacts/
          retention-days: 7

  promote:
    name: Promote + Publish Release
    runs-on: ubuntu-24.04
    needs: [prepare, build-images, security-govulncheck, security-images, e2e]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Promote tags (no rebuild)
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
          MANAGER_IMAGE: ${{ needs.prepare.outputs.manager_image }}
          CONFIG_INIT_IMAGE: ${{ needs.prepare.outputs.config_init_image }}
          BACKUP_EXECUTOR_IMAGE: ${{ needs.prepare.outputs.backup_executor_image }}
          UPGRADE_EXECUTOR_IMAGE: ${{ needs.prepare.outputs.upgrade_executor_image }}
          MANAGER_DIGEST: ${{ needs.build-images.outputs.manager_digest }}
          CONFIG_INIT_DIGEST: ${{ needs.build-images.outputs.config_init_digest }}
          BACKUP_EXECUTOR_DIGEST: ${{ needs.build-images.outputs.backup_executor_digest }}
          UPGRADE_EXECUTOR_DIGEST: ${{ needs.build-images.outputs.upgrade_executor_digest }}
        run: |
          set -euo pipefail
          docker buildx imagetools create -t "${MANAGER_IMAGE}:${VERSION}" "${MANAGER_IMAGE}@${MANAGER_DIGEST}"
          docker buildx imagetools create -t "${CONFIG_INIT_IMAGE}:${VERSION}" "${CONFIG_INIT_IMAGE}@${CONFIG_INIT_DIGEST}"
          docker buildx imagetools create -t "${BACKUP_EXECUTOR_IMAGE}:${VERSION}" "${BACKUP_EXECUTOR_IMAGE}@${BACKUP_EXECUTOR_DIGEST}"
          docker buildx imagetools create -t "${UPGRADE_EXECUTOR_IMAGE}:${VERSION}" "${UPGRADE_EXECUTOR_IMAGE}@${UPGRADE_EXECUTOR_DIGEST}"

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: v2.6.1

      - name: Sign images (keyless)
        env:
          MANAGER_IMAGE: ${{ needs.prepare.outputs.manager_image }}
          CONFIG_INIT_IMAGE: ${{ needs.prepare.outputs.config_init_image }}
          BACKUP_EXECUTOR_IMAGE: ${{ needs.prepare.outputs.backup_executor_image }}
          UPGRADE_EXECUTOR_IMAGE: ${{ needs.prepare.outputs.upgrade_executor_image }}
          MANAGER_DIGEST: ${{ needs.build-images.outputs.manager_digest }}
          CONFIG_INIT_DIGEST: ${{ needs.build-images.outputs.config_init_digest }}
          BACKUP_EXECUTOR_DIGEST: ${{ needs.build-images.outputs.backup_executor_digest }}
          UPGRADE_EXECUTOR_DIGEST: ${{ needs.build-images.outputs.upgrade_executor_digest }}
        run: |
          set -euo pipefail
          cosign sign --yes "${MANAGER_IMAGE}@${MANAGER_DIGEST}"
          cosign sign --yes "${CONFIG_INIT_IMAGE}@${CONFIG_INIT_DIGEST}"
          cosign sign --yes "${BACKUP_EXECUTOR_IMAGE}@${BACKUP_EXECUTOR_DIGEST}"
          cosign sign --yes "${UPGRADE_EXECUTOR_IMAGE}@${UPGRADE_EXECUTOR_DIGEST}"

      - name: Attest build provenance (GitHub) - manager
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-name: ${{ needs.prepare.outputs.manager_image }}
          subject-digest: ${{ needs.build-images.outputs.manager_digest }}
          push-to-registry: true

      - name: Attest build provenance (GitHub) - config-init
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-name: ${{ needs.prepare.outputs.config_init_image }}
          subject-digest: ${{ needs.build-images.outputs.config_init_digest }}
          push-to-registry: true

      - name: Attest build provenance (GitHub) - backup executor
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-name: ${{ needs.prepare.outputs.backup_executor_image }}
          subject-digest: ${{ needs.build-images.outputs.backup_executor_digest }}
          push-to-registry: true

      - name: Attest build provenance (GitHub) - upgrade executor
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-name: ${{ needs.prepare.outputs.upgrade_executor_image }}
          subject-digest: ${{ needs.build-images.outputs.upgrade_executor_digest }}
          push-to-registry: true

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Package and push Helm chart (OCI)
        env:
          CHART_VERSION: ${{ needs.prepare.outputs.chart_version }}
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          helm registry login ghcr.io -u "${GITHUB_ACTOR}" -p "${{ secrets.GITHUB_TOKEN }}"
          helm package charts/openbao-operator \
            --version "${CHART_VERSION}" \
            --app-version "${CHART_VERSION}"
          helm push "openbao-operator-${CHART_VERSION}.tgz" "oci://ghcr.io/${OWNER}/charts"

      - name: Setup Go (for crane)
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true

      - name: Sign Helm chart by digest (OCI)
        env:
          CHART_VERSION: ${{ needs.prepare.outputs.chart_version }}
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          go install github.com/google/go-containerregistry/cmd/crane@v0.20.7
          chart_ref="ghcr.io/${OWNER}/charts/openbao-operator:${CHART_VERSION}"
          chart_digest="$(crane digest "${chart_ref}")"
          cosign sign --yes "ghcr.io/${OWNER}/charts/openbao-operator@${chart_digest}"

      - name: Generate digest-pinned installer manifest
        env:
          MANAGER_IMAGE: ${{ needs.prepare.outputs.manager_image }}
          MANAGER_DIGEST: ${{ needs.build-images.outputs.manager_digest }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail
          make build-installer \
            IMG="${MANAGER_IMAGE}@${MANAGER_DIGEST}" \
            OPERATOR_VERSION="${VERSION}"

      - name: Generate CRDs manifest
        run: |
          set -euo pipefail
          make build-crds

      - name: Generate SBOMs (SPDX JSON)
        uses: anchore/sbom-action@62ad5284b8ced813296287a0b63906cb364b73ee # v0.22.0
        with:
          image: ${{ needs.prepare.outputs.manager_image }}@${{ needs.build-images.outputs.manager_digest }}
          format: spdx-json
          output-file: dist/sbom-openbao-operator.spdx.json
          upload-artifact: "false"
          upload-release-assets: "false"
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOMs (SPDX JSON) - config-init
        uses: anchore/sbom-action@62ad5284b8ced813296287a0b63906cb364b73ee # v0.22.0
        with:
          image: ${{ needs.prepare.outputs.config_init_image }}@${{ needs.build-images.outputs.config_init_digest }}
          format: spdx-json
          output-file: dist/sbom-openbao-init.spdx.json
          upload-artifact: "false"
          upload-release-assets: "false"
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOMs (SPDX JSON) - backup executor
        uses: anchore/sbom-action@62ad5284b8ced813296287a0b63906cb364b73ee # v0.22.0
        with:
          image: ${{ needs.prepare.outputs.backup_executor_image }}@${{ needs.build-images.outputs.backup_executor_digest }}
          format: spdx-json
          output-file: dist/sbom-openbao-backup.spdx.json
          upload-artifact: "false"
          upload-release-assets: "false"
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOMs (SPDX JSON) - upgrade executor
        uses: anchore/sbom-action@62ad5284b8ced813296287a0b63906cb364b73ee # v0.22.0
        with:
          image: ${{ needs.prepare.outputs.upgrade_executor_image }}@${{ needs.build-images.outputs.upgrade_executor_digest }}
          format: spdx-json
          output-file: dist/sbom-openbao-upgrade.spdx.json
          upload-artifact: "false"
          upload-release-assets: "false"
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate checksums
        run: |
          set -euo pipefail
          sha256sum dist/install.yaml dist/crds.yaml dist/sbom-*.spdx.json > dist/checksums.txt

      - name: Sign release checksums (keyless)
        run: |
          set -euo pipefail
          cosign sign-blob \
            --yes \
            --output-signature dist/checksums.txt.sig \
            --output-certificate dist/checksums.txt.crt \
            dist/checksums.txt

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          version="${{ needs.prepare.outputs.version }}"

          prerelease_flag=""
          if [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            prerelease_flag="--prerelease"
          fi

          # Source-of-truth for versioning and release notes is release-please.
          # This workflow only uploads release assets and publishes the draft release.
          if ! gh release view "${version}" >/dev/null 2>&1; then
            echo "GitHub Release '${version}' not found." >&2
            echo "Merge the release-please PR to create the tag and draft release." >&2
            exit 1
          fi

          gh release upload "${version}" \
            dist/install.yaml \
            dist/crds.yaml \
            dist/checksums.txt \
            dist/checksums.txt.sig \
            dist/checksums.txt.crt \
            dist/sbom-openbao-operator.spdx.json \
            dist/sbom-openbao-init.spdx.json \
            dist/sbom-openbao-backup.spdx.json \
            dist/sbom-openbao-upgrade.spdx.json \
            --clobber

          # Ensure releases are published and marked correctly.
          if [[ -n "${prerelease_flag}" ]]; then
            gh release edit "${version}" --title "${version}" --draft=false --prerelease
          else
            gh release edit "${version}" --title "${version}" --draft=false --latest
          fi

  deploy-docs:
    name: Deploy Versioned Docs
    runs-on: ubuntu-24.04
    needs: [prepare, promote]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.x"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv pip install --system mkdocs-material mike

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch gh-pages
        run: git fetch origin gh-pages --depth=1 || true

      - name: Deploy versioned docs
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail
          if [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            mike deploy --push "${VERSION}"
            exit 0
          fi
          mike deploy --push --update-aliases "${VERSION}" latest
